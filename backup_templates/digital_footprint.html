<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Digital Footprint Tracker | MyDataSafe</title>
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css">
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"/>
  <style>
    body {
      background: linear-gradient(135deg, #1e1e2f, #2c3e50);
      color: #fff;
      font-family: 'Poppins', sans-serif;
    }
    .container {
      margin-top: 100px;
    }
    .card {
      border: none;
      border-radius: 15px;
      background: rgba(255, 255, 255, 0.1);
      backdrop-filter: blur(8px);
      box-shadow: 0 4px 15px rgba(0,0,0,0.3);
    }
    .card h4 {
      font-weight: 600;
      color: #00bcd4;
    }
    .value {
      font-size: 1.1rem;
      color: #f1f1f1;
    }
    #loading {
      text-align: center;
      margin-top: 50px;
    }
    #map {
      height: 300px;
      border-radius: 10px;
      margin-top: 20px;
    }
  </style>
</head>
<body>

  {% include 'navbar.html' %}

  <div class="container">
    <h2 class="text-center mb-4">üåê Digital Footprint Tracker</h2>

    <div id="loading">
      <div class="spinner-border text-info" role="status">
        <span class="visually-hidden">Loading...</span>
      </div>
      <p class="mt-3">Analyzing your digital footprint...</p>
    </div>

    <div id="data-section" class="row g-4" style="display:none;">
      <!-- Network Info -->
      <div class="col-md-6">
        <div class="card p-4">
          <h4>IP Address</h4>
          <p class="value" id="ip">Loading...</p>
        </div>
      </div>
      <div class="col-md-6">
        <div class="card p-4">
          <h4>Location</h4>
          <p class="value" id="location">Loading...</p>
        </div>
      </div>
      <div class="col-md-6">
        <div class="card p-4">
          <h4>Organization</h4>
          <p class="value" id="org">Loading...</p>
        </div>
      </div>
      <div class="col-md-6">
        <div class="card p-4">
          <h4>Coordinates</h4>
          <p class="value" id="coords">Loading...</p>
        </div>
      </div>

      <!-- Browser & Device Info -->
      <div class="col-md-6">
        <div class="card p-4">
          <h4>Browser</h4>
          <p class="value" id="browser">Loading...</p>
        </div>
      </div>
      <div class="col-md-6">
        <div class="card p-4">
          <h4>Operating System</h4>
          <p class="value" id="os">Loading...</p>
        </div>
      </div>
      <div class="col-md-6">
        <div class="card p-4">
          <h4>Device Type</h4>
          <p class="value" id="device">Loading...</p>
        </div>
      </div>
      <div class="col-md-6">
        <div class="card p-4">
          <h4>Screen Resolution</h4>
          <p class="value" id="screen">Loading...</p>
        </div>
      </div>

      <!-- Map -->
      <div class="col-12">
        <div class="card p-4">
          <h4>Map View</h4>
          <div id="map"></div>
        </div>
      </div>
    </div>
  </div>

  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

  <script>
    async function fetchUserData() {
      try {
        const res = await fetch("/get_user_data");
        const data = await res.json();

        // Network info
        document.getElementById("ip").innerText = data.ip || "Unknown";
        document.getElementById("location").innerText =
          `${data.city || "Unknown"}, ${data.region || "Unknown"}, ${data.country || "Unknown"}`;
        document.getElementById("org").innerText = data.org || "Unknown";
        document.getElementById("coords").innerText =
          `${data.latitude || "?"}, ${data.longitude || "?"}`;

        // Browser & device info (client-side)
        const userAgent = navigator.userAgent;
        const browser = getBrowserName(userAgent);
        const os = getOSName(userAgent);
        const deviceType = /mobile/i.test(userAgent) ? "Mobile" : "Desktop";
        const screenRes = `${window.screen.width}x${window.screen.height}`;

        document.getElementById("browser").innerText = browser;
        document.getElementById("os").innerText = os;
        document.getElementById("device").innerText = deviceType;
        document.getElementById("screen").innerText = screenRes;

        document.getElementById("loading").style.display = "none";
        document.getElementById("data-section").style.display = "flex";

        // Map setup
        if (data.latitude && data.longitude) {
          const map = L.map('map').setView([data.latitude, data.longitude], 10);
          L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
            maxZoom: 19,
            attribution: '¬© OpenStreetMap'
          }).addTo(map);
          L.marker([data.latitude, data.longitude]).addTo(map)
            .bindPopup(`<b>Your Location</b><br>${data.city || "Unknown"}, ${data.country || "Unknown"}`)
            .openPopup();
        }
      } catch (error) {
        console.error("Error fetching data:", error);
        document.getElementById("loading").innerHTML =
          "<p class='text-danger'>Failed to fetch your digital footprint data.</p>";
      }
    }

    // Detect browser name
    function getBrowserName(ua) {
      if (ua.includes("Chrome")) return "Google Chrome";
      if (ua.includes("Firefox")) return "Mozilla Firefox";
      if (ua.includes("Safari") && !ua.includes("Chrome")) return "Apple Safari";
      if (ua.includes("Edg")) return "Microsoft Edge";
      if (ua.includes("OPR") || ua.includes("Opera")) return "Opera";
      return "Unknown Browser";
    }

    // Detect OS name
    function getOSName(ua) {
      if (ua.includes("Windows")) return "Windows";
      if (ua.includes("Mac OS")) return "macOS";
      if (ua.includes("Linux")) return "Linux";
      if (ua.includes("Android")) return "Android";
      if (ua.includes("iPhone") || ua.includes("iPad")) return "iOS";
      return "Unknown OS";
    }

    fetchUserData();
  </script>
</body>
</html>
